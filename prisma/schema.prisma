// Esquema de Base de Datos para Ecommerce Tiendanube
// Siguiendo Arquitectura Limpia y Convenciones en Español

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tabla de Usuarios Administradores
model Usuario {
  id              String    @id @default(cuid())
  email           String    @unique
  contrasena_hash String
  nombre          String
  apellido        String
  foto            String?   // URL o base64 de la foto de perfil
  telefono        String?   // Formato internacional E.164
  idioma          String    @default("es") // Código ISO 639-1
  zona_horaria    String    @default("America/Lima") // Zona horaria IANA
  rol             RolUsuario
  activo          Boolean   @default(true)
  fecha_creacion  DateTime  @default(now())
  fecha_actualizacion DateTime @updatedAt
  ultimo_acceso   DateTime?
  
  // Campos de seguridad
  correo_secundario     String?   // Email secundario para recuperación
  autenticacion_2pasos  Boolean   @default(false)
  fecha_verificacion_correo DateTime?
  fecha_verificacion_telefono DateTime?
  
  // Relaciones para perfil
  servicios_externos    ServicioExternoUsuario[]
  dispositivos_conectados DispositivoUsuario[]
  claves_acceso        ClaveAccesoUsuario[]
  metodos_autenticacion MetodoAutenticacionUsuario[]

  // Relaciones
  productos_creados Producto[] @relation("CreadorProducto")
  ordenes_creadas   Orden[]    @relation("CreadorOrden")
  clientes_creados  Cliente[]  @relation("CreadorCliente")
  colecciones_creadas Coleccion[] @relation("CreadorColeccion")
  ordenes_compra_creadas OrdenCompra[] @relation("CreadorOrdenCompra")
  transferencias_creadas TransferenciaProducto[] @relation("CreadorTransferencia")
  tarjetas_regalo_creadas TarjetaRegalo[] @relation("CreadorTarjetaRegalo")
  movimientos_inventario MovimientoInventario[]
  tiendas_propiedad Tienda[]   @relation("PropietarioTienda")
  asignaciones_tienda UsuarioTienda[]
  ordenes_compra    OrdenCompra[]     @relation("UsuarioOrdenCompra")
  transferencias    TransferenciaProducto[] @relation("UsuarioTransferencia")
  tarjetas_regalo   TarjetaRegalo[]   @relation("UsuarioTarjetaRegalo")
  cajas_apertura    Caja[]            @relation("UsuarioAperturaCaja")
  cajas_cierre      Caja[]            @relation("UsuarioCierreCaja")
  segmentos_creados SegmentoCliente[]
  paquetes_creados  PaqueteProducto[]
  paginas_creadas   Pagina[]
  blogs_creados     Blog[]
  articulos_blog_creados ArticuloBlog[]
  temas_creados     Tema[]
  integraciones_creadas Integracion[]
  tickets_creados   Ticket[]
  usuarios_sucursales UsuarioSucursal[]
  cambios_plan_creados HistorialPlan[]
  historial_contrasenas HistorialContrasena[]
  intentos_inicio_sesion IntentoInicioSesion[]

  @@map("usuarios")
}

enum RolUsuario {
  SUPER_ADMIN
  ADMIN
  EDITOR
  VENDEDOR
}

// Tabla de Clientes
model Cliente {
  id              String    @id @default(cuid())
  email           String    @unique
  nombre_completo String
  telefono        String?
  activo          Boolean   @default(true)
  fecha_creacion  DateTime  @default(now())
  fecha_actualizacion DateTime @updatedAt
  total_gastado   Decimal   @default(0)
  total_ordenes   Int       @default(0)
  fecha_ultima_orden DateTime?
  tags            String[]  // Array de tags para segmentación
  notas           String?   // Notas internas sobre el cliente
  acepta_marketing Boolean  @default(false)
  fuente_cliente  FuenteCliente @default(TIENDA_ONLINE) // Cómo llegó el cliente

  // Relaciones
  direcciones   Direccion[]
  ordenes       Orden[]
  creador_id    String
  creador       Usuario     @relation("CreadorCliente", fields: [creador_id], references: [id], onDelete: Cascade)
  tienda_id     String?
  tienda        Tienda?     @relation("TiendaCliente", fields: [tienda_id], references: [id])
  segmentos     ClienteSegmento[]
  tickets       Ticket[]

  @@map("clientes")
  @@index([total_gastado])
  @@index([total_ordenes])
  @@index([fecha_ultima_orden])
  @@index([acepta_marketing])
  @@index([fuente_cliente])
}

// Tabla de Direcciones de Clientes
model Direccion {
  id          String   @id @default(cuid())
  cliente_id  String
  cliente     Cliente  @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  tipo        TipoDireccion
  direccion   String
  ciudad      String
  provincia   String
  codigo_postal String
  pais        String   @default("Perú")
  principal   Boolean  @default(false)
  fecha_creacion DateTime @default(now())

  // Relaciones opuestas
  ordenes_envio Orden[] @relation("DireccionEnvio")

  @@map("direcciones")
}

enum TipoDireccion {
  ENVIO
  FACTURACION
}

// Tabla de Productos
model Producto {
  id              String    @id @default(cuid())
  titulo          String
  descripcion     String?
  precio          Decimal
  precio_comparacion Decimal?
  sku             String?   @unique
  codigo_barras   String?
  peso            Decimal?  // en gramos
  ancho           Decimal?  // en cm
  alto            Decimal?  // en cm
  profundidad     Decimal?  // en cm
  visible         Boolean   @default(true)
  fecha_creacion  DateTime  @default(now())
  fecha_actualizacion DateTime @updatedAt
  tienda_id       String?
  tienda          Tienda?   @relation("TiendaProducto", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario   @relation("CreadorProducto", fields: [creador_id], references: [id], onDelete: Cascade)
  
  // Nuevos campos para funcionalidades avanzadas
  proveedor       String?
  estado          EstadoProducto @default(ACTIVO)
  visible_tienda_online Boolean @default(true)
  visible_point_of_sale Boolean @default(true)
  tipo_producto   TipoProducto @default(FISICO)
  requiere_envio  Boolean   @default(true)
  inventario_gestionado Boolean @default(true)
  cantidad_inventario Int   @default(0)
  permite_backorder Boolean @default(false)
  tags            String[]  // Array de tags
  metatitulo      String?
  metadescripcion String?
  slug            String?   @unique
  fecha_publicacion DateTime?
  fecha_archivado DateTime?
  fecha_eliminado DateTime?

  // Relaciones
  variantes       Variante[]
  imagenes        ImagenProducto[]
  categorias      CategoriaProducto[]
  movimientos_inventario MovimientoInventario[]
  colecciones     ProductoColeccion[]
  items_orden_compra ItemOrdenCompra[] @relation("ProductoOrdenCompra")
  items_transferencia ItemTransferencia[] @relation("ProductoTransferencia")
  items_paquete   ItemPaquete[]
  productos_mercados ProductoMercado[]
  items_ticket    ItemTicket[]

  @@map("productos")
  @@index([tienda_id])
  @@index([estado])
  @@index([visible_tienda_online])
  @@index([visible_point_of_sale])
  @@index([slug])
  @@index([fecha_publicacion])
  @@index([fecha_archivado])
  @@index([fecha_eliminado])
}

enum EstadoProducto {
  ACTIVO
  ARCHIVADO
  ELIMINADO
}

enum TipoProducto {
  FISICO
  DIGITAL
  SERVICIO
}

// Tabla de Variantes de Productos
model Variante {
  id          String   @id @default(cuid())
  producto_id String
  producto    Producto @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  titulo      String
  precio      Decimal
  sku         String?  @unique
  codigo_barras String?
  peso        Decimal?
  inventario  Int      @default(0)
  activo      Boolean  @default(true)

  // Relaciones
  items_orden ItemOrden[]
  movimientos_inventario MovimientoInventario[]
  items_paquete ItemPaquete[]
  items_ticket ItemTicket[]

  @@map("variantes")
}

// Tabla de Imágenes de Productos
model ImagenProducto {
  id          String   @id @default(cuid())
  producto_id String
  producto    Producto @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  url         String
  alt_text    String?
  orden       Int      @default(0)
  fecha_creacion DateTime @default(now())

  @@map("imagenes_producto")
}

// Tabla de Categorías
model Categoria {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  slug        String   @unique
  activo      Boolean  @default(true)
  fecha_creacion DateTime @default(now())
  fecha_actualizacion DateTime @updatedAt

  // Relaciones
  productos   CategoriaProducto[]

  @@map("categorias")
}

// Tabla de relación muchos a muchos entre Productos y Categorías
model CategoriaProducto {
  id           String    @id @default(cuid())
  producto_id  String
  categoria_id String
  producto     Producto  @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  categoria    Categoria @relation(fields: [categoria_id], references: [id], onDelete: Cascade)

  @@map("categorias_productos")
  @@unique([producto_id, categoria_id])
}

// Tabla de Órdenes
model Orden {
  id              String        @id @default(cuid())
  numero_orden    String        @unique
  cliente_id      String
  cliente         Cliente       @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  estado          EstadoOrden   @default(PENDIENTE)
  subtotal        Decimal
  impuestos       Decimal
  total           Decimal
  metodo_pago     MetodoPago?
  estado_pago     EstadoPago    @default(PENDIENTE)
  metodo_envio    String?
  costo_envio     Decimal       @default(0)
  direccion_envio_id String?
  direccion_envio Direccion?    @relation("DireccionEnvio", fields: [direccion_envio_id], references: [id])
  notas           String?
  notas_internas  String?       // Notas internas del administrador
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  fecha_pago      DateTime?
  fecha_envio     DateTime?
  fecha_entrega   DateTime?
  fecha_abandono  DateTime?     // Para órdenes abandonadas
  es_borrador     Boolean       @default(false)
  archivada       Boolean       @default(false)
  motivo_cancelacion String?    // Razón de cancelación
  datos_cliente   Json?         // Datos del cliente al momento de la orden (snapshot)
  datos_envio     Json?         // Datos de envío al momento de la orden (snapshot)
  datos_facturacion Json?       // Datos de facturación al momento de la orden (snapshot)
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaOrden", fields: [tienda_id], references: [id])

  // Relaciones
  items           ItemOrden[]
  transacciones   TransaccionPago[]
  creador_id      String
  creador         Usuario       @relation("CreadorOrden", fields: [creador_id], references: [id], onDelete: Cascade)
  descuentos_aplicados OrdenDescuento[]
  envios          Envio[]       @relation("OrdenEnvio")
  orden_original_id String?     // Para reposición de órdenes
  orden_original  Orden?        @relation("OrdenReposicion", fields: [orden_original_id], references: [id])
  ordenes_reposicion Orden[]    @relation("OrdenReposicion")
  transacciones_tarjeta_regalo TransaccionTarjetaRegalo[]

  @@map("ordenes")
  @@index([es_borrador])
  @@index([archivada])
  @@index([fecha_abandono])
  @@index([orden_original_id])
  @@index([tienda_id])
}

enum EstadoOrden {
  PENDIENTE
  CONFIRMADA
  PROCESANDO
  ENVIADA
  ENTREGADA
  CANCELADA
  REEMBOLSADA
}

enum EstadoPago {
  PENDIENTE
  PAGADO
  FALLIDO
  REEMBOLSADO
  CANCELADO
}

enum MetodoPago {
  TARJETA_CREDITO
  PAYPAL
  TRANSFERENCIA
  EFECTIVO
}

// Tabla de Items de Órdenes
model ItemOrden {
  id          String   @id @default(cuid())
  orden_id    String
  orden       Orden    @relation(fields: [orden_id], references: [id], onDelete: Cascade)
  variante_id String
  variante    Variante @relation(fields: [variante_id], references: [id], onDelete: Cascade)
  cantidad    Int
  precio_unitario Decimal
  total       Decimal

  @@map("items_orden")
}

// Tabla de Transacciones de Pago
model TransaccionPago {
  id          String    @id @default(cuid())
  orden_id    String
  orden       Orden     @relation(fields: [orden_id], references: [id], onDelete: Cascade)
  metodo_pago MetodoPago
  monto       Decimal
  referencia  String?
  estado      EstadoTransaccion
  fecha_creacion DateTime @default(now())
  datos_extra Json?

  @@map("transacciones_pago")
}

enum EstadoTransaccion {
  EXITOSA
  FALLIDA
  PENDIENTE
  REEMBOLSADA
}

// Tabla de Movimientos de Inventario
model MovimientoInventario {
  id          String      @id @default(cuid())
  producto_id String
  producto    Producto    @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  variante_id String?
  variante    Variante?   @relation(fields: [variante_id], references: [id])
  tipo        TipoMovimientoInventario
  cantidad    Int
  stock_anterior Int
  stock_actual   Int
  motivo      String
  fecha_creacion DateTime  @default(now())
  usuario_id  String?
  usuario     Usuario?     @relation(fields: [usuario_id], references: [id])

  @@map("movimientos_inventario")
}

enum TipoMovimientoInventario {
  ENTRADA
  SALIDA
  AJUSTE
  VENTA
  DEVOLUCION
}

// Tabla de Descuentos y Cupones
model Descuento {
  id              String        @id @default(cuid())
  codigo          String        @unique
  tipo            TipoDescuento
  valor           Decimal
  valor_minimo    Decimal?      // Monto mínimo para aplicar el descuento
  usos_maximos    Int?          // Límite de usos totales
  usos_actuales   Int           @default(0)
  fecha_inicio    DateTime?
  fecha_fin       DateTime?
  activo          Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaDescuento", fields: [tienda_id], references: [id])
  
  // Nuevos campos para descuentos avanzados
  configuracion_avanzada Json?  // Configuración específica por tipo de descuento
  reglas_validacion Json?       // Reglas de validación complejas
  restricciones Json?           // Restricciones por país, segmentos, etc.
  nombre_campana String?        // Nombre de la campaña para UTM
  utm_source     String?        // Parámetro UTM source
  utm_medium     String?        // Parámetro UTM medium
  utm_campaign   String?        // Parámetro UTM campaign
  cantidad_lleva Int?           // Para lleva X paga Y: cantidad a llevar
  cantidad_paga  Int?           // Para lleva X paga Y: cantidad a pagar
  productos_aplicables String[] // IDs de productos a los que aplica el descuento
  colecciones_aplicables String[] // IDs de colecciones a las que aplica
  paises_permitidos String[]    // Países donde aplica el descuento
  segmentos_permitidos String[] // Segmentos de clientes permitidos
  requisitos_minimos Json?      // Requisitos mínimos específicos

  // Relaciones
  ordenes         OrdenDescuento[]

  @@map("descuentos")
  @@index([tipo])
  @@index([utm_campaign])
  @@index([nombre_campana])
}

enum TipoDescuento {
  PORCENTAJE
  MONTO_FIJO
  ENVIO_GRATIS
  SUBTOTAL_CARRITO
  LLEVA_X_PAGA_Y
  PROGRESIVO
  CAMPAÑA_UTM
  COMBO
}

// Tabla de relación entre Órdenes y Descuentos
model OrdenDescuento {
  id           String    @id @default(cuid())
  orden_id     String
  descuento_id String
  orden        Orden     @relation(fields: [orden_id], references: [id], onDelete: Cascade)
  descuento    Descuento @relation(fields: [descuento_id], references: [id], onDelete: Cascade)
  monto_descuento Decimal

  @@map("ordenes_descuentos")
  @@unique([orden_id, descuento_id])
}

// Tabla de Configuración de la Tienda
model ConfiguracionTienda {
  id          String   @id @default(cuid())
  clave       String   @unique
  valor       String
  tipo        TipoConfiguracion
  descripcion String?
  fecha_creacion DateTime @default(now())
  fecha_actualizacion DateTime @updatedAt
  tienda_id   String?
  tienda      Tienda?  @relation("TiendaConfiguracion", fields: [tienda_id], references: [id])

  // Campos adicionales para configuración estructurada
  nombre_tienda          String?
  descripcion_tienda     String?
  moneda                 Json?
  impuestos              Json?
  direccion              Json?
  contacto               Json?
  configuracion_envio    Json?
  configuracion_pagos    Json?
  configuracion_general  Json?
  configuracion_facturacion Json?  // Nueva configuración de facturación
  activa                 Boolean   @default(false)

  @@map("configuracion_tienda")
}

enum TipoConfiguracion {
  TEXTO
  NUMERO
  BOOLEANO
  JSON
}

// Tabla de Envíos
model Envio {
  id                    String      @id @default(cuid())
  orden_id              String
  orden                 Orden       @relation("OrdenEnvio", fields: [orden_id], references: [id], onDelete: Cascade)
  direccion_envio       Json        // Almacena DireccionEnvio como JSON
  metodo_envio          Json        // Almacena MetodoEnvio como JSON
  estado                EstadoEnvio @default(PENDIENTE)
  costo                 Decimal
  fecha_estimada_entrega DateTime
  fecha_creacion        DateTime    @default(now())
  fecha_actualizacion   DateTime    @updatedAt
  tracking_number       String?
  proveedor_envio       String?
  detalles              Json        // Almacena DetallesEnvio como JSON
  tienda_id             String?
  tienda                Tienda?     @relation("TiendaEnvio", fields: [tienda_id], references: [id])

  @@map("envios")
  @@index([orden_id])
  @@index([tracking_number])
  @@index([estado])
  @@index([fecha_creacion])
  @@index([tienda_id])
}

enum EstadoEnvio {
  PENDIENTE
  PROCESANDO
  ENVIADO
  EN_TRANSITO
  ENTREGADO
  CANCELADO
}

enum TipoMetodoEnvio {
  ESTANDAR
  EXPRESS
  INTERNACIONAL
  GRATIS
}

// Tabla de Tiendas (Multi-tenant)
model Tienda {
  id                    String        @id @default(cuid())
  nombre                String
  dominio               String        @unique
  configuracion         Json          // Almacena ConfiguracionTienda como JSON
  estado                EstadoTienda  @default(PENDIENTE)
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt
  propietario_id        String
  propietario           Usuario       @relation("PropietarioTienda", fields: [propietario_id], references: [id], onDelete: Cascade)
  suscripcion_plan      SuscripcionPlan?
  metadata              Json          // Almacena MetadataTienda como JSON

  // Relaciones
  productos             Producto[]    @relation("TiendaProducto")
  ordenes               Orden[]       @relation("TiendaOrden")
  clientes              Cliente[]     @relation("TiendaCliente")
  descuentos            Descuento[]   @relation("TiendaDescuento")
  envios                Envio[]       @relation("TiendaEnvio")
  configuraciones_tienda ConfiguracionTienda[] @relation("TiendaConfiguracion")
  asignaciones_tienda   UsuarioTienda[]
  colecciones           Coleccion[]   @relation("TiendaColeccion")
  ordenes_compra        OrdenCompra[] @relation("TiendaOrdenCompra")
  transferencias        TransferenciaProducto[] @relation("TiendaTransferencia")
  tarjetas_regalo       TarjetaRegalo[] @relation("TiendaTarjetaRegalo")
  segmentos             SegmentoCliente[] @relation("TiendaSegmento")
  paquetes              PaqueteProducto[] @relation("TiendaPaquete")
  mercados              Mercado[] @relation("TiendaMercado")
  paginas               Pagina[] @relation("TiendaPagina")
  blogs                 Blog[] @relation("TiendaBlog")
  categorias_blog       CategoriaBlog[] @relation("TiendaCategoriaBlog")
  menus                 Menu[] @relation("TiendaMenu")
  temas                 Tema[] @relation("TiendaTema")
  sucursales            Sucursal[] @relation("TiendaSucursal")
  integraciones         Integracion[] @relation("TiendaIntegracion")
  creditos_tienda       CreditoTienda[] @relation("TiendaCreditoTienda")
  recargas_creditos     RecargaCredito[] @relation("TiendaRecargaCredito")
  creditos_usados       CreditoUsado[] @relation("TiendaCreditoUsado")
  
  // Relaciones para configuraciones
  configuracion_sucursales ConfiguracionSucursales[] @relation("TiendaConfiguracionSucursales")
  configuracion_notificaciones ConfiguracionNotificaciones[] @relation("TiendaConfiguracionNotificaciones")
  configuracion_idiomas ConfiguracionIdiomas[] @relation("TiendaConfiguracionIdiomas")
  configuracion_politicas ConfiguracionPoliticas[] @relation("TiendaConfiguracionPoliticas")
  configuracion_aplicaciones_canales_venta ConfiguracionAplicacionesCanalesVenta[] @relation("TiendaConfiguracionAplicacionesCanalesVenta")
  configuracion_dominios ConfiguracionDominios[] @relation("TiendaConfiguracionDominios")
  configuracion_envio_entrega ConfiguracionEnvioEntrega[] @relation("TiendaConfiguracionEnvioEntrega")
  configuracion_usuarios_roles ConfiguracionUsuariosRoles[] @relation("TiendaConfiguracionUsuariosRoles")

  @@map("tiendas")
  @@index([dominio])
  @@index([estado])
  @@index([propietario_id])
  @@index([fecha_creacion])
}

enum EstadoTienda {
  PENDIENTE
  ACTIVA
  SUSPENDIDA
  CANCELADA
}

// Tabla de relación muchos a muchos entre Usuarios y Tiendas (para empleados)
model UsuarioTienda {
  id          String   @id @default(cuid())
  usuario_id  String
  tienda_id   String
  usuario     Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  tienda      Tienda   @relation(fields: [tienda_id], references: [id], onDelete: Cascade)
  rol         RolUsuarioTienda
  fecha_creacion DateTime @default(now())

  @@map("usuarios_tiendas")
  @@unique([usuario_id, tienda_id])
}

enum RolUsuarioTienda {
  PROPIETARIO
  ADMIN
  EDITOR
  VENDEDOR
  SOPORTE
}

// Tabla de Colecciones
model Coleccion {
  id              String    @id @default(cuid())
  nombre          String
  descripcion     String?
  slug            String    @unique
  imagen_url      String?
  estado          EstadoColeccion @default(ACTIVA)
  tipo            TipoColeccion @default(MANUAL)
  reglas          Json?     // Reglas para colecciones inteligentes
  visible_tienda_online Boolean @default(true)
  visible_point_of_sale Boolean @default(true)
  fecha_creacion  DateTime  @default(now())
  fecha_actualizacion DateTime @updatedAt
  tienda_id       String?
  tienda          Tienda?   @relation("TiendaColeccion", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario   @relation("CreadorColeccion", fields: [creador_id], references: [id], onDelete: Cascade)

  // Relaciones
  productos       ProductoColeccion[]

  @@map("colecciones")
  @@index([tienda_id])
  @@index([estado])
  @@index([tipo])
  @@index([slug])
  @@index([visible_tienda_online])
  @@index([visible_point_of_sale])
}

enum EstadoColeccion {
  ACTIVA
  ARCHIVADA
  ELIMINADA
}

enum TipoColeccion {
  MANUAL
  AUTOMATICA
}

// Tabla de relación muchos a muchos entre Productos y Colecciones
model ProductoColeccion {
  id           String    @id @default(cuid())
  producto_id  String
  coleccion_id String
  producto     Producto  @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  coleccion    Coleccion @relation(fields: [coleccion_id], references: [id], onDelete: Cascade)
  orden        Int       @default(0) // Orden dentro de la colección
  fecha_agregado DateTime @default(now())

  @@map("productos_colecciones")
  @@unique([producto_id, coleccion_id])
  @@index([coleccion_id, orden])
}

// Tabla de Órdenes de Compra (a proveedores)
model OrdenCompra {
  id              String        @id @default(cuid())
  numero_orden    String        @unique
  proveedor       String
  estado          EstadoOrdenCompra @default(BORRADOR)
  fecha_esperada  DateTime?
  fecha_entrega   DateTime?
  subtotal        Decimal
  impuestos       Decimal
  total           Decimal
  notas           String?
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaOrdenCompra", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario       @relation("CreadorOrdenCompra", fields: [creador_id], references: [id], onDelete: Cascade)
  usuario_id      String?
  usuario         Usuario?      @relation("UsuarioOrdenCompra", fields: [usuario_id], references: [id])

  // Relaciones
  items           ItemOrdenCompra[]

  @@map("ordenes_compra")
  @@index([tienda_id])
  @@index([estado])
  @@index([proveedor])
  @@index([fecha_creacion])
}

enum EstadoOrdenCompra {
  BORRADOR
  ENVIADA
  CONFIRMADA
  PARCIALMENTE_RECIBIDA
  COMPLETADA
  CANCELADA
}

// Tabla de Items de Órdenes de Compra
model ItemOrdenCompra {
  id              String    @id @default(cuid())
  orden_compra_id String
  orden_compra    OrdenCompra @relation(fields: [orden_compra_id], references: [id], onDelete: Cascade)
  producto_id     String
  producto        Producto  @relation("ProductoOrdenCompra", fields: [producto_id], references: [id], onDelete: Cascade)
  cantidad        Int
  precio_unitario Decimal
  total           Decimal
  cantidad_recibida Int     @default(0)

  @@map("items_orden_compra")
}

// Tabla de Transferencias de Productos
model TransferenciaProducto {
  id                String          @id @default(cuid())
  numero_transferencia String        @unique
  ubicacion_origen  String
  ubicacion_destino String
  estado            EstadoTransferencia @default(BORRADOR)
  fecha_esperada    DateTime?
  fecha_completada  DateTime?
  notas             String?
  fecha_creacion    DateTime        @default(now())
  fecha_actualizacion DateTime      @updatedAt
  tienda_id         String?
  tienda            Tienda?         @relation("TiendaTransferencia", fields: [tienda_id], references: [id])
  creador_id        String
  creador           Usuario         @relation("CreadorTransferencia", fields: [creador_id], references: [id], onDelete: Cascade)
  usuario_id        String?
  usuario           Usuario?        @relation("UsuarioTransferencia", fields: [usuario_id], references: [id])

  // Relaciones
  items             ItemTransferencia[]

  @@map("transferencias_productos")
  @@index([tienda_id])
  @@index([estado])
  @@index([ubicacion_origen])
  @@index([ubicacion_destino])
  @@index([fecha_creacion])
}

enum EstadoTransferencia {
  BORRADOR
  ENVIADA
  PARCIALMENTE_RECIBIDA
  COMPLETADA
  CANCELADA
}

// Tabla de Items de Transferencias
model ItemTransferencia {
  id                    String              @id @default(cuid())
  transferencia_id      String
  transferencia         TransferenciaProducto @relation(fields: [transferencia_id], references: [id], onDelete: Cascade)
  producto_id           String
  producto              Producto            @relation("ProductoTransferencia", fields: [producto_id], references: [id], onDelete: Cascade)
  cantidad_solicitada   Int
  cantidad_enviada      Int                 @default(0)
  cantidad_recibida     Int                 @default(0)

  @@map("items_transferencia")
}

// Tabla de Tarjetas de Regalo
model TarjetaRegalo {
  id              String        @id @default(cuid())
  codigo          String        @unique
  monto_inicial   Decimal
  monto_actual    Decimal
  estado          EstadoTarjetaRegalo @default(ACTIVA)
  fecha_creacion  DateTime      @default(now())
  fecha_expiracion DateTime?
  fecha_activacion DateTime?
  fecha_redimida  DateTime?
  notas           String?
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaTarjetaRegalo", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario       @relation("CreadorTarjetaRegalo", fields: [creador_id], references: [id], onDelete: Cascade)
  usuario_id      String?
  usuario         Usuario?      @relation("UsuarioTarjetaRegalo", fields: [usuario_id], references: [id])

  // Relaciones
  transacciones   TransaccionTarjetaRegalo[]

  @@map("tarjetas_regalo")
  @@index([tienda_id])
  @@index([estado])
  @@index([codigo])
  @@index([fecha_expiracion])
}

enum EstadoTarjetaRegalo {
  ACTIVA
  INACTIVA
  EXPIRADA
  REDIMIDA
  CANCELADA
}

// Tabla de Transacciones de Tarjetas de Regalo
model TransaccionTarjetaRegalo {
  id                String        @id @default(cuid())
  tarjeta_regalo_id String
  tarjeta_regalo    TarjetaRegalo @relation(fields: [tarjeta_regalo_id], references: [id], onDelete: Cascade)
  tipo              TipoTransaccionTarjetaRegalo
  monto             Decimal
  orden_id          String?
  orden             Orden?        @relation(fields: [orden_id], references: [id])
  notas             String?
  fecha_creacion    DateTime      @default(now())

  @@map("transacciones_tarjeta_regalo")
  @@index([tarjeta_regalo_id])
  @@index([orden_id])
}

enum TipoTransaccionTarjetaRegalo {
  ACTIVACION
  REDENCION
  AJUSTE
  CANCELACION
}

// Tabla de Segmentos de Clientes
model SegmentoCliente {
  id              String        @id @default(cuid())
  nombre          String
  descripcion     String?
  tipo            TipoSegmento
  reglas          Json          // Reglas de segmentación en formato JSON
  activo          Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaSegmento", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario       @relation(fields: [creador_id], references: [id], onDelete: Cascade)

  // Relaciones
  clientes        ClienteSegmento[]

  @@map("segmentos_clientes")
  @@index([tienda_id])
  @@index([tipo])
  @@index([activo])
}

// Tabla de relación muchos a muchos entre Clientes y Segmentos
model ClienteSegmento {
  id           String         @id @default(cuid())
  cliente_id   String
  segmento_id  String
  cliente      Cliente        @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  segmento     SegmentoCliente @relation(fields: [segmento_id], references: [id], onDelete: Cascade)
  fecha_agregado DateTime     @default(now())

  @@map("clientes_segmentos")
  @@unique([cliente_id, segmento_id])
}

enum TipoSegmento {
  MANUAL
  AUTOMATICO
  DINAMICO
}

enum FuenteCliente {
  TIENDA_ONLINE
  PUNTO_VENTA
  IMPORTACION_CSV
  REFERIDO
  REDES_SOCIALES
  MARKETING_EMAIL
  OTRO
}

// Tabla de Paquetes/Combos de Productos
model PaqueteProducto {
  id              String    @id @default(cuid())
  nombre          String
  descripcion     String?
  precio          Decimal
  precio_comparacion Decimal?
  sku             String?   @unique
  activo          Boolean   @default(true)
  fecha_creacion  DateTime  @default(now())
  fecha_actualizacion DateTime @updatedAt
  tienda_id       String?
  tienda          Tienda?   @relation("TiendaPaquete", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario   @relation(fields: [creador_id], references: [id], onDelete: Cascade)

  // Relaciones
  items           ItemPaquete[]

  @@map("paquetes_productos")
  @@index([tienda_id])
  @@index([activo])
}

// Tabla de Items de Paquetes
model ItemPaquete {
  id               String         @id @default(cuid())
  paquete_id       String
  paquete          PaqueteProducto @relation(fields: [paquete_id], references: [id], onDelete: Cascade)
  producto_id      String
  producto         Producto       @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  variante_id      String?
  variante         Variante?      @relation(fields: [variante_id], references: [id])
  cantidad         Int
  precio_unitario  Decimal?

  @@map("items_paquete")
  @@unique([paquete_id, producto_id, variante_id])
}

// Tabla de Mercados/Multi-tienda
model Mercado {
  id              String        @id @default(cuid())
  nombre          String
  codigo          String        @unique
  moneda          String        @default("PEN")
  idioma          String        @default("es")
  zona_horaria    String        @default("America/Lima")
  activo          Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaMercado", fields: [tienda_id], references: [id])
  configuracion   Json          // Configuración específica del mercado

  // Relaciones
  productos_mercado ProductoMercado[]

  @@map("mercados")
  @@index([tienda_id])
  @@index([activo])
  @@index([codigo])
}

// Tabla de relación entre Productos y Mercados
model ProductoMercado {
  id           String    @id @default(cuid())
  producto_id  String
  mercado_id   String
  producto     Producto  @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  mercado      Mercado   @relation(fields: [mercado_id], references: [id], onDelete: Cascade)
  precio       Decimal?
  disponible   Boolean   @default(true)
  fecha_creacion DateTime @default(now())
  fecha_actualizacion DateTime @updatedAt

  @@map("productos_mercados")
  @@unique([producto_id, mercado_id])
  @@index([mercado_id, disponible])
}

// Tabla de Páginas de la Tienda Online
model Pagina {
  id              String        @id @default(cuid())
  titulo          String
  contenido       String?
  slug            String        @unique
  meta_titulo     String?
  meta_descripcion String?
  visible         Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  fecha_publicacion DateTime?
  autor_id        String
  autor           Usuario       @relation(fields: [autor_id], references: [id], onDelete: Cascade)
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaPagina", fields: [tienda_id], references: [id])

  @@map("paginas")
  @@index([tienda_id])
  @@index([visible])
  @@index([slug])
  @@index([fecha_publicacion])
}

// Tabla de Blogs
model Blog {
  id              String        @id @default(cuid())
  titulo          String
  descripcion     String?
  slug            String        @unique
  visible         Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  autor_id        String
  autor           Usuario       @relation(fields: [autor_id], references: [id], onDelete: Cascade)
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaBlog", fields: [tienda_id], references: [id])

  // Relaciones
  articulos       ArticuloBlog[]

  @@map("blogs")
  @@index([tienda_id])
  @@index([visible])
  @@index([slug])
}

// Tabla de Artículos de Blog
model ArticuloBlog {
  id              String        @id @default(cuid())
  blog_id         String
  blog            Blog          @relation(fields: [blog_id], references: [id], onDelete: Cascade)
  titulo          String
  contenido       String?
  extracto        String?
  slug            String
  meta_titulo     String?
  meta_descripcion String?
  visible         Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  fecha_publicacion DateTime?
  autor_id        String
  autor           Usuario       @relation(fields: [autor_id], references: [id], onDelete: Cascade)
  imagen_url      String?

  // Relaciones
  categorias_articulo CategoriaArticulo[]

  @@map("articulos_blog")
  @@unique([blog_id, slug])
  @@index([blog_id])
  @@index([visible])
  @@index([fecha_publicacion])
  @@index([slug])
}

// Tabla de Categorías de Artículos de Blog
model CategoriaBlog {
  id              String        @id @default(cuid())
  nombre          String
  descripcion     String?
  slug            String        @unique
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaCategoriaBlog", fields: [tienda_id], references: [id])

  // Relaciones
  articulos       CategoriaArticulo[]

  @@map("categorias_blog")
  @@index([tienda_id])
  @@index([slug])
}

// Tabla de relación muchos a muchos entre Artículos y Categorías de Blog
model CategoriaArticulo {
  id                String        @id @default(cuid())
  articulo_blog_id  String
  categoria_blog_id String
  articulo_blog     ArticuloBlog  @relation(fields: [articulo_blog_id], references: [id], onDelete: Cascade)
  categoria_blog    CategoriaBlog @relation(fields: [categoria_blog_id], references: [id], onDelete: Cascade)

  @@map("categorias_articulos")
  @@unique([articulo_blog_id, categoria_blog_id])
}

// Tabla de Menús de Navegación
model Menu {
  id              String        @id @default(cuid())
  nombre          String
  slug            String        @unique
  ubicacion       UbicacionMenu
  activo          Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaMenu", fields: [tienda_id], references: [id])

  // Relaciones
  items           ItemMenu[]

  @@map("menus")
  @@index([tienda_id])
  @@index([ubicacion])
  @@index([activo])
  @@index([slug])
}

enum UbicacionMenu {
  HEADER
  FOOTER
  SIDEBAR
  MOBILE
}

// Tabla de Items de Menús (recursiva)
model ItemMenu {
  id              String        @id @default(cuid())
  menu_id         String
  menu            Menu          @relation(fields: [menu_id], references: [id], onDelete: Cascade)
  titulo          String
  url             String?
  tipo            TipoItemMenu
  orden           Int           @default(0)
  padre_id        String?       // Para menús anidados
  padre           ItemMenu?     @relation("MenuRecursivo", fields: [padre_id], references: [id])
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt

  // Relaciones opuestas
  items_hijos     ItemMenu[]    @relation("MenuRecursivo")

  @@map("items_menu")
  @@index([menu_id])
  @@index([padre_id])
  @@index([orden])
  @@index([tipo])
}

enum TipoItemMenu {
  ENLACE
  PAGINA
  COLECCION
  PRODUCTO
  BLOG
  CATEGORIA
  PERSONALIZADO
}

// Tabla de Temas
model Tema {
  id              String        @id @default(cuid())
  nombre          String
  descripcion     String?
  activo          Boolean       @default(false)
  es_predeterminado Boolean     @default(false)
  configuracion   Json          // Configuración del tema en JSON
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaTema", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario       @relation(fields: [creador_id], references: [id], onDelete: Cascade)

  @@map("temas")
  @@index([tienda_id])
  @@index([activo])
  @@index([es_predeterminado])
}

// Tabla de Sucursales para POS
model Sucursal {
  id              String        @id @default(cuid())
  nombre          String
  direccion       String
  ciudad          String
  provincia       String
  codigo_postal   String
  pais            String        @default("Perú")
  telefono        String?
  email           String?
  activo          Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaSucursal", fields: [tienda_id], references: [id])

  // Relaciones
  cajas           Caja[]
  usuarios_sucursal UsuarioSucursal[]

  @@map("sucursales")
  @@index([tienda_id])
  @@index([activo])
}

// Tabla de Cajas de POS
model Caja {
  id              String        @id @default(cuid())
  sucursal_id     String
  sucursal        Sucursal      @relation(fields: [sucursal_id], references: [id], onDelete: Cascade)
  nombre          String
  estado          EstadoCaja    @default(CERRADA)
  saldo_inicial   Decimal       @default(0)
  saldo_actual    Decimal       @default(0)
  fecha_apertura  DateTime?
  fecha_cierre    DateTime?
  usuario_apertura_id String?
  usuario_apertura Usuario?     @relation("UsuarioAperturaCaja", fields: [usuario_apertura_id], references: [id])
  usuario_cierre_id String?
  usuario_cierre  Usuario?      @relation("UsuarioCierreCaja", fields: [usuario_cierre_id], references: [id])
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt

  // Relaciones
  tickets         Ticket[]

  @@map("cajas")
  @@index([sucursal_id])
  @@index([estado])
  @@index([fecha_apertura])
  @@index([fecha_cierre])
}

enum EstadoCaja {
  ABIERTA
  CERRADA
  SUSPENDIDA
}

// Tabla de Tickets de Venta POS
model Ticket {
  id              String        @id @default(cuid())
  caja_id         String
  caja            Caja          @relation(fields: [caja_id], references: [id], onDelete: Cascade)
  numero_ticket   String        @unique
  cliente_id      String?
  cliente         Cliente?      @relation(fields: [cliente_id], references: [id])
  subtotal        Decimal
  impuestos       Decimal
  total           Decimal
  metodo_pago     MetodoPago
  estado_pago     EstadoPago    @default(PAGADO)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  usuario_id      String
  usuario         Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  // Relaciones
  items_ticket    ItemTicket[]

  @@map("tickets")
  @@index([caja_id])
  @@index([numero_ticket])
  @@index([fecha_creacion])
  @@index([usuario_id])
}

// Tabla de Items de Tickets
model ItemTicket {
  id              String        @id @default(cuid())
  ticket_id       String
  ticket          Ticket        @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  producto_id     String
  producto        Producto      @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  variante_id     String?
  variante        Variante?     @relation(fields: [variante_id], references: [id])
  cantidad        Int
  precio_unitario Decimal
  total           Decimal

  @@map("items_ticket")
}

// Tabla de relación muchos a muchos entre Usuarios y Sucursales
model UsuarioSucursal {
  id          String   @id @default(cuid())
  usuario_id  String
  sucursal_id String
  usuario     Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  sucursal    Sucursal @relation(fields: [sucursal_id], references: [id], onDelete: Cascade)
  fecha_creacion DateTime @default(now())

  @@map("usuarios_sucursales")
  @@unique([usuario_id, sucursal_id])
}

// Tabla de Integraciones con APIs Externas
model Integracion {
  id              String        @id @default(cuid())
  nombre          String
  tipo            TipoIntegracion
  configuracion   Json          // Configuración de la integración
  activo          Boolean       @default(false)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  tienda_id       String?
  tienda          Tienda?       @relation("TiendaIntegracion", fields: [tienda_id], references: [id])
  creador_id      String
  creador         Usuario       @relation(fields: [creador_id], references: [id], onDelete: Cascade)

  @@map("integraciones")
  @@index([tienda_id])
  @@index([tipo])
  @@index([activo])
}

enum TipoIntegracion {
  FACEBOOK
  INSTAGRAM
  TIKTOK
  GOOGLE_SHOPPING
  WHATSAPP
  EMAIL_MARKETING
  ANALYTICS
  OTRO
}

// Tabla de Créditos de Tienda (Sistema de Balance)
model CreditoTienda {
  id                    String   @id @default(cuid())
  tienda_id             String   @unique
  tienda                Tienda   @relation("TiendaCreditoTienda", fields: [tienda_id], references: [id], onDelete: Cascade)
  creditos_disponibles  Int      @default(0)
  creditos_usados       Int      @default(0)
  fecha_creacion        DateTime @default(now())
  fecha_actualizacion   DateTime @updatedAt

  @@map("creditos_tienda")
  @@index([tienda_id])
  @@index([creditos_disponibles])
  @@index([creditos_usados])
}

// Tabla de Recargas de Créditos
model RecargaCredito {
  id                String            @id @default(cuid())
  tienda_id         String
  tienda            Tienda            @relation("TiendaRecargaCredito", fields: [tienda_id], references: [id], onDelete: Cascade)
  monto_dolares     Decimal
  creditos_agregados Int              // monto_dolares * 100
  id_pago_stripe    String?           @unique
  estado            EstadoRecarga     @default(PENDIENTE)
  fecha_recarga     DateTime          @default(now())
  fecha_actualizacion DateTime        @updatedAt

  @@map("recargas_creditos")
  @@index([tienda_id])
  @@index([id_pago_stripe])
  @@index([estado])
  @@index([fecha_recarga])
}

enum EstadoRecarga {
  PENDIENTE
  COMPLETADO
  FALLIDO
}

// Tabla de Uso de Créditos
model CreditoUsado {
  id                    String                @id @default(cuid())
  tienda_id             String
  tienda                Tienda                @relation("TiendaCreditoUsado", fields: [tienda_id], references: [id], onDelete: Cascade)
  cantidad_creditos     Int
  tipo_servicio         TipoServicioCredito
  descripcion_servicio  String
  id_referencia         String?               // ID de la entidad que consumió los créditos
  metadata              Json?                 // Datos adicionales del uso
  fecha_uso             DateTime              @default(now())

  @@map("creditos_usados")
  @@index([tienda_id])
  @@index([tipo_servicio])
  @@index([fecha_uso])
  @@index([id_referencia])
}

enum TipoServicioCredito {
  IA
  API
  WEBHOOK
  REDES_SOCIALES
  OTRO
}

// Tabla de Planes de Suscripción
model Plan {
  id                    String        @id @default(cuid())
  nombre                String
  codigo                String        @unique
  descripcion           String?
  precio_mensual        Decimal
  precio_anual          Decimal?
  moneda                String        @default("USD")
  estado                EstadoPlan    @default(ACTIVO)
  caracteristicas       Json          // Array de características del plan
  limites               Json          // Límites del plan (productos, órdenes, etc.)
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  // Relaciones
  suscripciones         SuscripcionPlan[]
  cambios_plan_anteriores HistorialPlan[] @relation("PlanAnterior")
  cambios_plan_nuevos   HistorialPlan[] @relation("PlanNuevo")

  @@map("planes")
  @@index([codigo])
  @@index([estado])
  @@index([precio_mensual])
}

enum EstadoPlan {
  ACTIVO
  INACTIVO
  ARCHIVADO
}

// Tabla de Suscripciones de Plan por Tienda
model SuscripcionPlan {
  id                    String        @id @default(cuid())
  tienda_id             String        @unique
  tienda                Tienda        @relation(fields: [tienda_id], references: [id], onDelete: Cascade)
  plan_id               String
  plan                  Plan          @relation(fields: [plan_id], references: [id], onDelete: Cascade)
  estado                EstadoSuscripcion @default(ACTIVA)
  ciclo_facturacion     CicloFacturacion @default(MENSUAL)
  fecha_inicio          DateTime
  fecha_renovacion      DateTime
  fecha_cancelacion     DateTime?
  metodo_pago_id        String?       // ID del método de pago en Stripe/PayPal
  metodo_pago_tipo      String?       // "stripe", "paypal", etc.
  ultimo_pago_fecha     DateTime?
  proximo_pago_fecha    DateTime?
  total_pagado          Decimal       @default(0)
  datos_facturacion     Json?         // Datos de facturación
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  // Relaciones
  historial_pagos       PagoPlan[]
  cambios_plan          HistorialPlan[]

  @@map("suscripciones_planes")
  @@index([tienda_id])
  @@index([plan_id])
  @@index([estado])
  @@index([fecha_renovacion])
  @@index([fecha_cancelacion])
}

enum EstadoSuscripcion {
  ACTIVA
  PENDIENTE
  CANCELADA
  SUSPENDIDA
  EXPIRADA
}

enum CicloFacturacion {
  MENSUAL
  ANUAL
  SEMESTRAL
  TRIMESTRAL
}

// Tabla de Historial de Cambios de Plan
model HistorialPlan {
  id                    String        @id @default(cuid())
  suscripcion_id        String
  suscripcion           SuscripcionPlan @relation(fields: [suscripcion_id], references: [id], onDelete: Cascade)
  plan_anterior_id      String?
  plan_anterior         Plan?         @relation("PlanAnterior", fields: [plan_anterior_id], references: [id])
  plan_nuevo_id         String
  plan_nuevo            Plan          @relation("PlanNuevo", fields: [plan_nuevo_id], references: [id], onDelete: Cascade)
  fecha_cambio          DateTime      @default(now())
  motivo                String?
  datos_cambio          Json?         // Datos adicionales del cambio
  usuario_id            String?
  usuario               Usuario?      @relation(fields: [usuario_id], references: [id])

  @@map("historial_planes")
  @@index([suscripcion_id])
  @@index([fecha_cambio])
  @@index([plan_anterior_id])
  @@index([plan_nuevo_id])
}

// Tabla de Pagos de Planes
model PagoPlan {
  id                    String        @id @default(cuid())
  suscripcion_id        String
  suscripcion           SuscripcionPlan @relation(fields: [suscripcion_id], references: [id], onDelete: Cascade)
  monto                 Decimal
  moneda                String        @default("USD")
  estado                EstadoPagoPlan @default(EXITOSO)
  fecha_pago            DateTime
  fecha_vencimiento     DateTime?
  referencia_pago       String?       // ID de transacción en gateway de pago
  metodo_pago           String?       // Método de pago utilizado
  datos_pago            Json?         // Datos adicionales del pago
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("pagos_planes")
  @@index([suscripcion_id])
  @@index([estado])
  @@index([fecha_pago])
  @@index([referencia_pago])
}

enum EstadoPagoPlan {
  PENDIENTE
  EXITOSO
  FALLIDO
  REEMBOLSADO
  CANCELADO
}

// Tabla de Configuración de Sucursales
model ConfiguracionSucursales {
  id                    String        @id @default(cuid())
  tienda_id             String
  tienda                Tienda        @relation("TiendaConfiguracionSucursales", fields: [tienda_id], references: [id], onDelete: Cascade)
  nombre_sucursal       String
  direccion             Json          // Almacena DireccionSucursalDto como JSON
  estado                EstadoSucursal @default(ACTIVA)
  suscripcion_pos       TipoSuscripcionPos?
  capacidad_stock       Int?
  productos_asignados   Json?         // Almacena ProductoAsignadoDto[] como JSON
  ventas_persona_estado Boolean       @default(false)
  metodos_pago_local    String[]      // Array de métodos de pago
  responsable           String?       // Email del responsable
  horario               Json?         // Almacena HorarioAperturaDto como JSON
  telefono              String?
  email                 String?
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_sucursales")
  @@unique([tienda_id, nombre_sucursal])
  @@index([tienda_id])
  @@index([estado])
  @@index([suscripcion_pos])
  @@index([ventas_persona_estado])
  @@index([responsable])
  @@index([fecha_creacion])
}

enum EstadoSucursal {
  ACTIVA
  INACTIVA
}

enum TipoSuscripcionPos {
  POS_PRO
  POS_LITE
}

// Tabla de Configuración de Notificaciones
model ConfiguracionNotificaciones {
  id                    String        @id @default(cuid())
  tienda_id             String        @unique
  tienda                Tienda        @relation("TiendaConfiguracionNotificaciones", fields: [tienda_id], references: [id], onDelete: Cascade)
  email_remitente       String
  verificado            Boolean       @default(false)
  dmarc_autenticado     Boolean       @default(false)
  notificaciones_clientes Json        // Almacena NotificacionClienteDto[] como JSON
  notificaciones_empleados Json       // Almacena NotificacionEmpleadoDto[] como JSON
  webhooks              Json?         // Almacena WebhookDto[] como JSON
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_notificaciones")
  @@index([tienda_id])
  @@index([verificado])
  @@index([dmarc_autenticado])
  @@index([fecha_creacion])
}

// Tabla de Configuración de Idiomas
model ConfiguracionIdiomas {
  id                    String        @id @default(cuid())
  tienda_id             String
  tienda                Tienda        @relation("TiendaConfiguracionIdiomas", fields: [tienda_id], references: [id], onDelete: Cascade)
  codigo_idioma         String
  nombre_idioma         String
  estado                EstadoIdioma  @default(NO_PUBLICADO)
  predeterminado        Boolean       @default(false)
  dominios_asociados    String[]      // Array de dominios asociados
  estado_traduccion     EstadoTraduccion @default(SIN_TRADUCIR)
  porcentaje_traduccion Int           @default(0) // 0-100
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_idiomas")
  @@unique([tienda_id, codigo_idioma])
  @@index([tienda_id])
  @@index([codigo_idioma])
  @@index([estado])
  @@index([predeterminado])
  @@index([estado_traduccion])
  @@index([fecha_creacion])
}

enum EstadoIdioma {
  PUBLICADO
  NO_PUBLICADO
}

enum EstadoTraduccion {
  SIN_TRADUCIR
  EN_PROGRESO
  TRADUCIDO
}

// Tabla de Configuración de Políticas y Devoluciones
model ConfiguracionPoliticas {
  id                    String        @id @default(cuid())
  tienda_id             String
  tienda                Tienda        @relation("TiendaConfiguracionPoliticas", fields: [tienda_id], references: [id], onDelete: Cascade)
  estado_reglas_devolucion EstadoReglasDevolucion @default(DESACTIVADO)
  reglas_devolucion     Json          // Almacena ReglaDevolucionDto[] como JSON
  politica_privacidad   Json          // Almacena PoliticaPrivacidadDto como JSON
  terminos_servicio     Json          // Almacena TerminosServicioDto como JSON
  politica_envios       Json          // Almacena PoliticaEnvioDto como JSON
  informacion_contacto  Json          // Almacena InformacionContactoDto como JSON
  productos_venta_final String[]      // Array de IDs de productos de venta final
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_politicas")
  @@unique([tienda_id])
  @@index([tienda_id])
  @@index([estado_reglas_devolucion])
  @@index([fecha_creacion])
  @@index([fecha_actualizacion])
}

enum EstadoReglasDevolucion {
  ACTIVADO
  DESACTIVADO
}

// Tabla de Configuración de Aplicaciones y Canales de Venta
model ConfiguracionAplicacionesCanalesVenta {
  id                    String        @id @default(cuid())
  tienda_id             String        @unique
  tienda                Tienda        @relation("TiendaConfiguracionAplicacionesCanalesVenta", fields: [tienda_id], references: [id], onDelete: Cascade)
  apps_instaladas       Json          // Almacena AppInstaladaDto[] como JSON
  canales_venta         Json          // Almacena CanalVentaDto[] como JSON
  apps_desarrollo       Json          // Almacena AppDesarrolloDto[] como JSON
  apps_desinstaladas    Json          // Almacena AppDesinstaladaDto[] como JSON
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_aplicaciones_canales_venta")
  @@index([tienda_id])
  @@index([fecha_creacion])
  @@index([fecha_actualizacion])
}

// Enums para Aplicaciones y Canales de Venta
enum TipoApp {
  TIENDA_ONLINE
  FLUJO_TRABAJO
  LANDING_PAGE
  PUNTO_VENTA
  MARKETING
  ANALYTICS
  INVENTARIO
  ENVIO
  PAGOS
  CLIENTES
  SOPORTE
  INTEGRACION
  DESARROLLO
  OTRO
}

enum TipoCanal {
  TIENDA_ONLINE
  POS
  APP_EXTERNA
  MARKETPLACE
  REDES_SOCIALES
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  TIKTOK
  EMAIL
  TELEFONO
  PRESENCIAL
  OTRO
}

enum EstadoApp {
  EN_DESARROLLO
  PUBLICADA
  ARCHIVADA
  SUSPENDIDA
}

enum EstadoRevision {
  PENDIENTE
  APROBADO
  RECHAZADO
}

// Tabla de Configuración de Dominios
model ConfiguracionDominios {
  id                    String        @id @default(cuid())
  tienda_id             String        @unique
  tienda                Tienda        @relation("TiendaConfiguracionDominios", fields: [tienda_id], references: [id], onDelete: Cascade)
  dominios              Json          // Almacena DominioDto[] como JSON
  dominio_principal     String?       // Nombre del dominio principal
  redireccionamiento_global Boolean   @default(false)
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_dominios")
  @@index([tienda_id])
  @@index([dominio_principal])
  @@index([redireccionamiento_global])
  @@index([fecha_creacion])
}

// Enums para Configuración de Dominios
enum TipoDominio {
  PRINCIPAL
  SECUNDARIO
  SUBDOMINIO
}

enum EstadoConexionDominio {
  CONECTADO
  VERIFICANDO
  DESCONECTADO
}

enum FuenteDominio {
  COMPRADO_EN_SHOPIFY
  EXTERNO
  MYSHOPIFY
}

// Tabla de Configuración de Envío y Entrega
model ConfiguracionEnvioEntrega {
  id                    String        @id @default(cuid())
  tienda_id             String        @unique
  tienda                Tienda        @relation("TiendaConfiguracionEnvioEntrega", fields: [tienda_id], references: [id], onDelete: Cascade)
  perfiles_envio        Json          // Almacena PerfilEnvioDto[] como JSON
  metodos_entrega       Json          // Almacena MetodoEntregaDto[] como JSON
  embalajes             Json          // Almacena EmbalajeDto[] como JSON
  proveedores_transporte Json         // Almacena ProveedorTransporteDto[] como JSON
  plantillas_documentacion Json       // Almacena PlantillaDocumentacionDto[] como JSON
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_envio_entrega")
  @@index([tienda_id])
  @@index([fecha_creacion])
  @@index([fecha_actualizacion])
}

// Enums para Configuración de Envío y Entrega
enum TipoEntrega {
  ENVIO_NACIONAL
  ENVIO_INTERNACIONAL
  ENTREGA_LOCAL
  RETIRO_TIENDA
  PUNTO_RECOGIDA
  EXPRESS
  ESTANDAR
  GRATIS
}

enum TipoTarifa {
  FIJA
  CALCULADA
  GRATUITA
  POR_PESO
  POR_VOLUMEN
  MIXTA
}

enum TipoEmbalaje {
  CAJA
  SOBRE
  TUBO
  PAQUETE
  BOLSA
  PERSONALIZADO
}

enum EstadoProveedorTransporte {
  ACTIVO
  INACTIVO
  PENDIENTE_APROBACION
  SUSPENDIDO
}

// Tablas para Gestión de Perfil y Seguridad

// Tabla de Servicios Externos Vinculados al Usuario
model ServicioExternoUsuario {
  id              String        @id @default(cuid())
  usuario_id      String
  usuario         Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  proveedor       ProveedorServicioExterno
  id_externo      String        // ID del usuario en el servicio externo
  email_externo   String?       // Email asociado en el servicio externo
  datos_conexion  Json?         // Datos de conexión y tokens (encriptados)
  activo          Boolean       @default(true)
  fecha_conexion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt
  fecha_desconexion DateTime?

  @@map("servicios_externos_usuario")
  @@unique([usuario_id, proveedor])
  @@index([usuario_id])
  @@index([proveedor])
  @@index([activo])
  @@index([fecha_conexion])
}

enum ProveedorServicioExterno {
  APPLE
  FACEBOOK
  GOOGLE
}

// Tabla de Dispositivos Conectados del Usuario
model DispositivoUsuario {
  id              String        @id @default(cuid())
  usuario_id      String
  usuario         Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  nombre_dispositivo String     // Nombre descriptivo del dispositivo
  tipo_dispositivo TipoDispositivo
  navegador       String?       // Nombre del navegador
  sistema_operativo String?     // Sistema operativo
  user_agent      String?       // User agent completo
  ip_conexion     String?       // IP de la última conexión
  fecha_conexion  DateTime      @default(now())
  fecha_ultima_actividad DateTime @updatedAt
  activo          Boolean       @default(true)
  token_sesion    String?       @unique // Token de sesión (encriptado)

  @@map("dispositivos_usuario")
  @@index([usuario_id])
  @@index([tipo_dispositivo])
  @@index([activo])
  @@index([fecha_conexion])
  @@index([fecha_ultima_actividad])
}

enum TipoDispositivo {
  MOVIL
  TABLET
  COMPUTADORA
  OTRO
}

// Tabla de Claves de Acceso (Passkeys)
model ClaveAccesoUsuario {
  id              String        @id @default(cuid())
  usuario_id      String
  usuario         Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  nombre_clave    String        // Nombre descriptivo de la clave
  tipo_clave      TipoClaveAcceso
  credencial_id   String        @unique // ID de la credencial WebAuthn
  clave_publica   String        // Clave pública (encriptada)
  contador_uso    Int           @default(0)
  fecha_creacion  DateTime      @default(now())
  fecha_ultimo_uso DateTime?
  activo          Boolean       @default(true)

  @@map("claves_acceso_usuario")
  @@index([usuario_id])
  @@index([tipo_clave])
  @@index([activo])
  @@index([fecha_creacion])
}

enum TipoClaveAcceso {
  PLATAFORMA
  SEGURIDAD
  CROSS_PLATFORM
}

// Tabla de Métodos de Autenticación para 2FA
model MetodoAutenticacionUsuario {
  id              String        @id @default(cuid())
  usuario_id      String
  usuario         Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  tipo_metodo     TipoMetodoAutenticacion
  configuracion   Json          // Configuración específica del método
  activo          Boolean       @default(true)
  fecha_creacion  DateTime      @default(now())
  fecha_actualizacion DateTime  @updatedAt

  @@map("metodos_autenticacion_usuario")
  @@unique([usuario_id, tipo_metodo])
  @@index([usuario_id])
  @@index([tipo_metodo])
  @@index([activo])
}

enum TipoMetodoAutenticacion {
  CODIGO_TEMPORAL
  CLAVE_SEGURIDAD
  DISPOSITIVO_CONFIANZA
  APLICACION_AUTENTICACION
}

// Tabla de Historial de Cambios de Contraseña
model HistorialContrasena {
  id              String        @id @default(cuid())
  usuario_id      String
  usuario         Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  contrasena_hash String        // Hash de la contraseña anterior
  fecha_cambio    DateTime      @default(now())
  motivo_cambio   MotivoCambioContrasena?
  ip_solicitud    String?       // IP desde donde se solicitó el cambio

  @@map("historial_contrasenas")
  @@index([usuario_id])
  @@index([fecha_cambio])
}

enum MotivoCambioContrasena {
  INICIO_SESION_SEGURO
  SOLICITUD_USUARIO
  RESET_ADMINISTRADOR
  COMPROMETIDA
  EXPIRACION
}

// Tabla de Tokens de Recuperación de Contraseña
model TokenRecuperacionContrasena {
  id              String        @id @default(cuid())
  usuario_id      String
  usuario         Usuario       @relation(fields: [usuario_id], references: [id], onDelete: Cascade)
  token           String        @unique
  expiracion      DateTime
  utilizado       Boolean       @default(false)
  fecha_creacion  DateTime      @default(now())

  @@map("tokens_recuperacion_contrasena")
  @@index([usuario_id])
  @@index([token])
  @@index([expiracion])
  @@index([utilizado])
}

// Tabla de Intentos de Inicio de Sesión
model IntentoInicioSesion {
  id              String        @id @default(cuid())
  usuario_id      String?
  usuario         Usuario?      @relation(fields: [usuario_id], references: [id])
  email           String        // Email utilizado en el intento
  exito           Boolean       @default(false)
  ip_intento      String?
  user_agent      String?
  fecha_intento   DateTime      @default(now())
  motivo_fallo    MotivoFalloInicioSesion?

  @@map("intentos_inicio_sesion")
  @@index([usuario_id])
  @@index([email])
  @@index([exito])
  @@index([fecha_intento])
}

enum MotivoFalloInicioSesion {
  CREDENCIALES_INCORRECTAS
  USUARIO_BLOQUEADO
  INTENTOS_EXCEDIDOS
  DOS_FACTORES_REQUERIDOS
  SESION_EXPIRADA
  OTRO
}

// Tabla de Configuración de Usuarios y Roles
model ConfiguracionUsuariosRoles {
  id                    String        @id @default(cuid())
  tienda_id             String        @unique
  tienda                Tienda        @relation("TiendaConfiguracionUsuariosRoles", fields: [tienda_id], references: [id], onDelete: Cascade)
  roles_personalizados  Json?         // Almacena RolPersonalizadoDto[] como JSON
  configuracion_seguridad Json        // Almacena ConfiguracionSeguridadDto como JSON
  solicitudes_colaboradores Json?     // Almacena SolicitudColaboradorDto[] como JSON
  registro_actividad    Json?         // Almacena RegistroActividadDto[] como JSON
  fecha_creacion        DateTime      @default(now())
  fecha_actualizacion   DateTime      @updatedAt

  @@map("configuracion_usuarios_roles")
  @@index([tienda_id])
  @@index([fecha_creacion])
}
